name: 2. FMCSA Extractor (Single Batch)

on:
  workflow_dispatch:
    inputs:
      batch_index:
        description: 'The index of the batch to process (e.g., 0, 1, 2)'
        required: true
      batch_size:
        description: 'Number of MCs per batch'
        required: true
      concurrency:
        description: 'Parallel requests for the extractor script'
        required: true

jobs:
  run-extraction:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create batch.txt for this specific job
        run: |
          START_LINE=$(( ${{ github.event.inputs.batch_index }} * ${{ github.event.inputs.batch_size }} + 1 ))
          BATCH_SIZE=${{ github.event.inputs.batch_size }}
          tail -n +$START_LINE mc_list.txt | head -n $BATCH_SIZE > batch.txt
          echo "âœ… Created batch.txt for index ${{ github.event.inputs.batch_index }} with $(wc -l < batch.txt) lines."

      - name: Run the extractor script and capture logs
        # <<< YEH STEP UPDATE KIYA GAYA HAI
        id: run_script
        env:
          CONCURRENCY: ${{ github.event.inputs.concurrency }}
          BATCH_INDEX: ${{ github.event.inputs.batch_index }}
        run: |
          mkdir -p output
          # Script ki tamam output (console.log aur errors) ko run.log file mein save karein
          node extractor.js > output/run.log 2>&1

      - name: Upload logs and CSV as an artifact
        # <<< YEH STEP UPDATE KIYA GAYA HAI
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fmcsa-output-batch-${{ github.event.inputs.batch_index }}
          # Ab yeh poora output folder upload karega (CSV aur log file dono)
          path: output/
          if-no-files-found: ignore
          retention-days: 1
