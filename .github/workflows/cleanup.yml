name: FMCSA Cleanup

permissions:
  actions: write    # workflows delete karne ke liye required

on:
  workflow_run:
    workflows: ["FMCSA Post Merge"]   # jab Post Merge complete ho, tab trigger hoga
    types:
      - completed

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate with GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Delete old extractor runs
        env:
          REPO: ${{ github.repository }}
        run: |
          echo "ðŸ”Ž Fetching last 20 runs of extractor workflow..."
          runs=$(gh run list --workflow="FMCSA Extractor (Single Batch)" --limit 20 --json databaseId -q '.[].databaseId' --repo "$REPO")

          if [ -z "$runs" ]; then
            echo "âš  No extractor runs found."
            exit 0
          fi

          for run_id in $runs; do
            echo "ðŸ—‘ Deleting run $run_id"
            gh run delete $run_id --confirm --repo "$REPO" || echo "âš  Failed to delete run $run_id"
          done
