name: FMCSA Cleanup

permissions:
  actions: write

on:
  workflow_run:
    workflows: ["FMCSA Post Merge"]
    types:
      - completed

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old extractor runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python - <<'EOF'
          import os, requests

          repo = os.getenv("REPO")
          token = os.getenv("GITHUB_TOKEN")
          headers = {"Authorization": f"token " + token}

          # Get last 100 workflow runs
          url = f"https://api.github.com/repos/{repo}/actions/runs?per_page=100"
          resp = requests.get(url, headers=headers)
          runs = resp.json().get("workflow_runs", [])

          print(f"🔎 Total runs fetched: {len(runs)}")
          deleted = 0

          for run in runs:
              print("➡️ Found run:", run["name"], "ID:", run["id"])
              if run["name"].strip() == "FMCSA Extractor (Single Batch)":
                  run_id = run["id"]
                  del_url = f"https://api.github.com/repos/{repo}/actions/runs/{run_id}"
                  del_resp = requests.delete(del_url, headers=headers)
                  if del_resp.status_code == 204:
                      print(f"🗑 Deleted extractor run {run_id}")
                      deleted += 1
                  else:
                      print(f"⚠ Failed to delete run {run_id}: {del_resp.status_code} {del_resp.text}")

          print(f"✅ Cleanup done — Deleted {deleted} extractor runs")
          EOF
